<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JobMatch AI - Find Jobs That Match YOU</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0a0a0f; color: #e2e8f0; min-height: 100vh; }
    
    /* Layout */
    .app { display: flex; min-height: 100vh; }
    .sidebar { width: 260px; background: #12121a; border-right: 1px solid #1e1e2e; padding: 20px; position: fixed; height: 100vh; overflow-y: auto; }
    .main { flex: 1; margin-left: 260px; padding: 24px; max-width: 1200px; }
    
    @media (max-width: 900px) {
      .sidebar { display: none; }
      .main { margin-left: 0; }
    }
    
    /* Sidebar */
    .logo { font-size: 1.3rem; font-weight: 700; margin-bottom: 32px; display: flex; align-items: center; gap: 10px; }
    .logo span { background: linear-gradient(135deg, #6366f1, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; cursor: pointer; margin-bottom: 4px; color: #94a3b8; transition: all 0.2s; font-size: 0.95rem; }
    .nav-item:hover { background: #1e1e2e; color: #e2e8f0; }
    .nav-item.active { background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.1)); color: #a5b4fc; border: 1px solid rgba(99, 102, 241, 0.3); }
    .nav-item .icon { font-size: 1.2rem; }
    .nav-item .badge { background: #6366f1; color: white; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; margin-left: auto; }
    
    .profile-mini { margin-top: auto; padding: 16px; background: #1e1e2e; border-radius: 12px; margin-top: 32px; }
    .profile-mini h4 { font-size: 0.85rem; color: #94a3b8; margin-bottom: 8px; }
    .profile-mini .name { font-weight: 600; font-size: 0.95rem; }
    .profile-mini .title { font-size: 0.8rem; color: #64748b; }
    
    /* Cards */
    .card { background: #12121a; border: 1px solid #1e1e2e; border-radius: 16px; padding: 24px; margin-bottom: 20px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .card-title { font-size: 1.1rem; font-weight: 600; }
    .card-subtitle { font-size: 0.85rem; color: #64748b; margin-top: 4px; }
    
    /* Buttons */
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; font-size: 0.95rem; font-weight: 600; border: none; border-radius: 10px; cursor: pointer; transition: all 0.2s; }
    .btn-primary { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; }
    .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3); }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    .btn-secondary { background: #1e1e2e; color: #e2e8f0; border: 1px solid #2e2e3e; }
    .btn-secondary:hover { background: #2e2e3e; }
    .btn-sm { padding: 8px 16px; font-size: 0.85rem; }
    .btn-ghost { background: transparent; color: #94a3b8; }
    .btn-ghost:hover { color: #e2e8f0; }
    
    /* Upload Zone */
    .upload-zone { border: 2px dashed #2e2e3e; border-radius: 16px; padding: 48px; text-align: center; cursor: pointer; transition: all 0.2s; }
    .upload-zone:hover { border-color: #6366f1; background: rgba(99, 102, 241, 0.05); }
    .upload-zone.has-file { border-color: #10b981; background: rgba(16, 185, 129, 0.05); }
    .upload-zone.dragging { border-color: #6366f1; background: rgba(99, 102, 241, 0.1); }
    .upload-zone input { display: none; }
    .upload-icon { font-size: 3rem; margin-bottom: 16px; }
    .upload-text { color: #94a3b8; margin-bottom: 8px; }
    .upload-hint { color: #64748b; font-size: 0.85rem; }
    .file-name { color: #10b981; font-weight: 600; margin-top: 12px; }
    
    /* Profile Display */
    .profile-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; }
    .profile-item { background: #1e1e2e; padding: 16px; border-radius: 12px; }
    .profile-item label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em; display: block; margin-bottom: 6px; }
    .profile-item .value { font-size: 0.95rem; font-weight: 500; }
    
    .skills-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
    .skill-tag { background: rgba(99, 102, 241, 0.15); color: #a5b4fc; padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; }
    
    /* Search Box */
    .search-box { display: flex; gap: 12px; margin-bottom: 24px; }
    .search-input { flex: 1; background: #1e1e2e; border: 1px solid #2e2e3e; border-radius: 10px; padding: 14px 18px; color: #e2e8f0; font-size: 0.95rem; }
    .search-input:focus { outline: none; border-color: #6366f1; }
    .search-input::placeholder { color: #64748b; }
    
    /* Job Cards */
    .job-list { display: flex; flex-direction: column; gap: 16px; }
    
    .job-card { background: #12121a; border: 1px solid #1e1e2e; border-radius: 14px; padding: 20px; transition: all 0.2s; cursor: pointer; }
    .job-card:hover { border-color: #3e3e4e; transform: translateX(4px); }
    .job-card.excellent { border-left: 4px solid #10b981; }
    .job-card.good { border-left: 4px solid #6366f1; }
    .job-card.moderate { border-left: 4px solid #f59e0b; }
    .job-card.low { border-left: 4px solid #ef4444; }
    
    .job-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .job-title { font-size: 1.05rem; font-weight: 600; margin-bottom: 4px; }
    .job-company { color: #94a3b8; font-size: 0.9rem; }
    .job-meta { display: flex; gap: 16px; color: #64748b; font-size: 0.85rem; margin-top: 8px; }
    
    .match-score { text-align: right; }
    .match-percent { font-size: 1.5rem; font-weight: 700; line-height: 1; }
    .match-percent.high { color: #10b981; }
    .match-percent.medium { color: #f59e0b; }
    .match-percent.low { color: #ef4444; }
    .match-label { font-size: 0.7rem; color: #64748b; text-transform: uppercase; }
    
    .job-quick-take { background: #1e1e2e; padding: 12px; border-radius: 8px; margin-top: 12px; font-size: 0.9rem; color: #94a3b8; }
    
    .job-actions { display: flex; gap: 8px; margin-top: 16px; }
    
    .recommendation-badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
    .recommendation-badge.apply-now { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .recommendation-badge.worth-it { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; }
    .recommendation-badge.customize { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .recommendation-badge.skip { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    
    /* Modal */
    .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center; padding: 20px; }
    .modal.open { display: flex; }
    .modal-content { background: #12121a; border: 1px solid #2e2e3e; border-radius: 20px; width: 100%; max-width: 700px; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 24px; border-bottom: 1px solid #1e1e2e; position: sticky; top: 0; background: #12121a; z-index: 1; }
    .modal-body { padding: 24px; }
    .modal-close { background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer; padding: 4px; }
    .modal-close:hover { color: #e2e8f0; }
    
    /* Analysis in Modal */
    .analysis-section { margin-bottom: 24px; }
    .analysis-section h4 { font-size: 0.9rem; color: #64748b; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; }
    
    .analysis-item { background: #1e1e2e; padding: 14px; border-radius: 10px; margin-bottom: 8px; }
    .analysis-item.success { border-left: 3px solid #10b981; }
    .analysis-item.danger { border-left: 3px solid #ef4444; }
    .analysis-item.warning { border-left: 3px solid #f59e0b; }
    
    /* Cover Letter */
    .cover-letter-box { background: #1e1e2e; border-radius: 12px; padding: 20px; font-size: 0.95rem; line-height: 1.8; white-space: pre-wrap; }
    
    /* Saved Jobs / Tracker */
    .tracker-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .stat-card { background: #1e1e2e; padding: 16px; border-radius: 12px; text-align: center; }
    .stat-number { font-size: 1.8rem; font-weight: 700; }
    .stat-number.saved { color: #6366f1; }
    .stat-number.applied { color: #f59e0b; }
    .stat-number.interview { color: #10b981; }
    .stat-number.rejected { color: #ef4444; }
    .stat-label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; margin-top: 4px; }
    
    .status-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; }
    .status-badge.saved { background: rgba(99, 102, 241, 0.2); color: #a5b4fc; }
    .status-badge.applied { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .status-badge.interview { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .status-badge.rejected { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .status-badge.offer { background: rgba(16, 185, 129, 0.3); color: #10b981; }
    
    /* Empty State */
    .empty-state { text-align: center; padding: 48px; color: #64748b; }
    .empty-state .icon { font-size: 3rem; margin-bottom: 16px; opacity: 0.5; }
    .empty-state h3 { color: #94a3b8; margin-bottom: 8px; }
    
    /* Loading */
    .loading { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    .loading-overlay { position: absolute; inset: 0; background: rgba(10, 10, 15, 0.9); display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 16px; z-index: 10; }
    .loading-text { margin-top: 16px; color: #94a3b8; }
    
    /* Toast */
    .toast { position: fixed; bottom: 24px; right: 24px; padding: 16px 24px; background: #1e1e2e; border: 1px solid #2e2e3e; color: white; border-radius: 12px; transform: translateY(100px); opacity: 0; transition: all 0.3s; z-index: 2000; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .toast.success { border-color: #10b981; }
    .toast.error { border-color: #ef4444; background: #ef4444; }
    
    /* Tabs */
    .tabs { display: flex; gap: 4px; margin-bottom: 24px; background: #1e1e2e; padding: 4px; border-radius: 12px; }
    .tab { flex: 1; padding: 12px; text-align: center; border-radius: 8px; cursor: pointer; color: #94a3b8; font-weight: 500; transition: all 0.2s; }
    .tab:hover { color: #e2e8f0; }
    .tab.active { background: #6366f1; color: white; }
    
    /* Section visibility */
    .section { display: none; }
    .section.active { display: block; }
    
    /* Misc */
    .divider { height: 1px; background: #1e1e2e; margin: 24px 0; }
    .text-muted { color: #64748b; }
    .text-success { color: #10b981; }
    .text-danger { color: #ef4444; }
    .text-warning { color: #f59e0b; }
    .mb-2 { margin-bottom: 8px; }
    .mb-4 { margin-bottom: 16px; }
    .mt-4 { margin-top: 16px; }
    .flex { display: flex; }
    .gap-2 { gap: 8px; }
    .gap-4 { gap: 16px; }
    .items-center { align-items: center; }
    .justify-between { justify-content: space-between; }
    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 600px) { .grid-2 { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="logo">üéØ <span>JobMatch AI</span></div>
      
      <nav>
        <div class="nav-item active" data-section="profile">
          <span class="icon">üë§</span>
          <span>My Profile</span>
        </div>
        <div class="nav-item" data-section="search">
          <span class="icon">üîç</span>
          <span>Find Jobs</span>
          <span class="badge" id="jobs-count" style="display: none;">0</span>
        </div>
        <div class="nav-item" data-section="tracker">
          <span class="icon">üìã</span>
          <span>My Jobs</span>
          <span class="badge" id="saved-count" style="display: none;">0</span>
        </div>
      </nav>
      
      <div class="profile-mini" id="profile-mini" style="display: none;">
        <h4>Current Profile</h4>
        <div class="name" id="mini-name">-</div>
        <div class="title" id="mini-title">-</div>
      </div>
    </aside>
    
    <!-- Main Content -->
    <main class="main">
      <!-- Profile Section -->
      <section class="section active" id="section-profile">
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="card-title">Upload Your Resume</h2>
              <p class="card-subtitle">We'll extract your profile and find matching jobs</p>
            </div>
          </div>
          
          <div class="upload-zone" id="upload-zone">
            <input type="file" id="resume-input" accept=".pdf,.doc,.docx">
            <div class="upload-icon">üìÑ</div>
            <div class="upload-text">Drop your resume here or click to browse</div>
            <div class="upload-hint">PDF or Word document</div>
            <div class="file-name" id="file-name"></div>
          </div>
          
          <button class="btn btn-primary" id="extract-btn" style="width: 100%; margin-top: 20px;" disabled>
            <span id="extract-btn-text">Extract My Profile</span>
            <span class="loading" id="extract-loading" style="display: none;"></span>
          </button>
        </div>
        
        <!-- Extracted Profile -->
        <div class="card" id="profile-card" style="display: none;">
          <div class="card-header">
            <div>
              <h2 class="card-title">Your Profile</h2>
              <p class="card-subtitle">Extracted from your resume</p>
            </div>
            <button class="btn btn-primary" id="find-jobs-btn">üîç Find Matching Jobs</button>
          </div>
          
          <div class="profile-grid" id="profile-display">
            <!-- Filled by JS -->
          </div>
          
          <div class="divider"></div>
          
          <div>
            <label style="font-size: 0.85rem; color: #64748b; margin-bottom: 8px; display: block;">Skills</label>
            <div class="skills-list" id="skills-display"></div>
          </div>
          
          <div class="divider"></div>
          
          <div>
            <label style="font-size: 0.85rem; color: #64748b; margin-bottom: 8px; display: block;">Target Roles</label>
            <div class="skills-list" id="titles-display"></div>
          </div>
        </div>
      </section>
      
      <!-- Search Section -->
      <section class="section" id="section-search">
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="card-title">Find Jobs</h2>
              <p class="card-subtitle">Jobs ranked by how well YOU match</p>
            </div>
          </div>
          
          <div class="search-box">
            <input type="text" class="search-input" id="search-query" placeholder="Job title, skills, or company...">
            <input type="text" class="search-input" id="search-location" placeholder="Location" style="max-width: 200px;">
            <button class="btn btn-primary" id="search-btn">
              <span id="search-btn-text">Search</span>
              <span class="loading" id="search-loading" style="display: none;"></span>
            </button>
          </div>
        </div>
        
        <!-- No Profile Warning -->
        <div class="card" id="no-profile-warning" style="display: none;">
          <div class="empty-state">
            <div class="icon">üë§</div>
            <h3>Upload Your Resume First</h3>
            <p>We need your profile to find matching jobs</p>
            <button class="btn btn-primary mt-4" onclick="showSection('profile')">Upload Resume</button>
          </div>
        </div>
        
        <!-- Job Results -->
        <div id="job-results" style="display: none;">
          <div class="flex justify-between items-center mb-4">
            <h3><span id="results-count">0</span> Jobs Found</h3>
            <div class="tabs" style="margin: 0; width: auto;">
              <div class="tab active" data-filter="all">All</div>
              <div class="tab" data-filter="excellent">üü¢ Best</div>
              <div class="tab" data-filter="good">üîµ Good</div>
            </div>
          </div>
          
          <div class="job-list" id="job-list">
            <!-- Filled by JS -->
          </div>
        </div>
      </section>
      
      <!-- Tracker Section -->
      <section class="section" id="section-tracker">
        <div class="card">
          <div class="card-header">
            <div>
              <h2 class="card-title">Application Tracker</h2>
              <p class="card-subtitle">Track your job applications</p>
            </div>
          </div>
          
          <div class="tracker-stats">
            <div class="stat-card">
              <div class="stat-number saved" id="stat-saved">0</div>
              <div class="stat-label">Saved</div>
            </div>
            <div class="stat-card">
              <div class="stat-number applied" id="stat-applied">0</div>
              <div class="stat-label">Applied</div>
            </div>
            <div class="stat-card">
              <div class="stat-number interview" id="stat-interview">0</div>
              <div class="stat-label">Interviews</div>
            </div>
            <div class="stat-card">
              <div class="stat-number rejected" id="stat-rejected">0</div>
              <div class="stat-label">Rejected</div>
            </div>
          </div>
        </div>
        
        <div class="job-list" id="saved-jobs-list">
          <div class="empty-state" id="no-saved-jobs">
            <div class="icon">üìã</div>
            <h3>No Saved Jobs Yet</h3>
            <p>Save jobs from search results to track them here</p>
          </div>
        </div>
      </section>
    </main>
  </div>
  
  <!-- Job Detail Modal -->
  <div class="modal" id="job-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h3 id="modal-job-title">Job Title</h3>
          <p class="text-muted" id="modal-job-company">Company</p>
        </div>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modal-body">
        <!-- Filled by JS -->
      </div>
    </div>
  </div>
  
  <!-- Cover Letter Modal -->
  <div class="modal" id="cover-letter-modal">
    <div class="modal-content">
      <div class="modal-header">
        <div>
          <h3>Cover Letter</h3>
          <p class="text-muted" id="cl-job-info">For: Job at Company</p>
        </div>
        <button class="modal-close" onclick="closeCoverLetterModal()">&times;</button>
      </div>
      <div class="modal-body">
        <div class="cover-letter-box" id="cover-letter-text">
          Generating...
        </div>
        <div class="flex gap-2 mt-4">
          <button class="btn btn-primary" onclick="copyCoverLetter()">üìã Copy to Clipboard</button>
          <button class="btn btn-secondary" onclick="regenerateCoverLetter()">üîÑ Regenerate</button>
        </div>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>
  
  <script>
    // State
    let sessionId = localStorage.getItem('jobmatch_session') || null;
    let profile = null;
    let jobs = [];
    let savedJobs = [];
    let currentJob = null;
    let selectedFile = null;
    
    // Elements
    const uploadZone = document.getElementById('upload-zone');
    const resumeInput = document.getElementById('resume-input');
    const fileNameEl = document.getElementById('file-name');
    const extractBtn = document.getElementById('extract-btn');
    
    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        const section = item.dataset.section;
        showSection(section);
      });
    });
    
    function showSection(section) {
      document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
      document.querySelector(`.nav-item[data-section="${section}"]`).classList.add('active');
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.getElementById(`section-${section}`).classList.add('active');
      
      if (section === 'search' && !profile) {
        document.getElementById('no-profile-warning').style.display = 'block';
        document.getElementById('job-results').style.display = 'none';
      }
    }
    
    // File Upload
    uploadZone.addEventListener('click', () => resumeInput.click());
    uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragging'); });
    uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragging'));
    uploadZone.addEventListener('drop', e => { e.preventDefault(); uploadZone.classList.remove('dragging'); if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); });
    resumeInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });
    
    function handleFile(file) {
      if (!file.name.match(/\.(pdf|doc|docx)$/i)) { showToast('Please upload PDF or Word', 'error'); return; }
      selectedFile = file;
      fileNameEl.textContent = '‚úì ' + file.name;
      uploadZone.classList.add('has-file');
      extractBtn.disabled = false;
    }
    
    // Extract Profile
    extractBtn.addEventListener('click', async () => {
      if (!selectedFile) return;
      
      setLoading(extractBtn, 'extract', true, 'Analyzing resume...');
      
      try {
        const formData = new FormData();
        formData.append('resume', selectedFile);
        
        const res = await fetch('/api/extract-profile', { method: 'POST', body: formData });
        const data = await res.json();
        
        if (!data.success) throw new Error(data.error);
        
        sessionId = data.data.sessionId;
        profile = data.data.profile;
        localStorage.setItem('jobmatch_session', sessionId);
        
        displayProfile(profile);
        showToast('Profile extracted successfully!', 'success');
        
      } catch (err) {
        showToast(err.message || 'Failed to extract profile', 'error');
      } finally {
        setLoading(extractBtn, 'extract', false, 'Extract My Profile');
      }
    });
    
    function displayProfile(p) {
      document.getElementById('profile-card').style.display = 'block';
      document.getElementById('profile-mini').style.display = 'block';
      
      document.getElementById('mini-name').textContent = p.name || 'Unknown';
      document.getElementById('mini-title').textContent = p.currentTitle || 'Professional';
      
      document.getElementById('profile-display').innerHTML = `
        <div class="profile-item"><label>Name</label><div class="value">${p.name || '-'}</div></div>
        <div class="profile-item"><label>Current Title</label><div class="value">${p.currentTitle || '-'}</div></div>
        <div class="profile-item"><label>Experience</label><div class="value">${p.yearsExperience || '?'} years (${p.experienceLevel || 'Unknown'})</div></div>
        <div class="profile-item"><label>Location</label><div class="value">${p.location || '-'}</div></div>
        <div class="profile-item"><label>Education</label><div class="value">${p.education?.degree || '-'} in ${p.education?.field || '-'}</div></div>
      `;
      
      document.getElementById('skills-display').innerHTML = (p.hardSkills || []).map(s => `<span class="skill-tag">${s}</span>`).join('');
      document.getElementById('titles-display').innerHTML = (p.targetTitles || []).map(t => `<span class="skill-tag">${t}</span>`).join('');
      
      // Pre-fill search
      if (p.targetTitles?.[0]) document.getElementById('search-query').value = p.targetTitles[0];
      if (p.location) document.getElementById('search-location').value = p.location;
    }
    
    // Find Jobs Button
    document.getElementById('find-jobs-btn').addEventListener('click', () => {
      showSection('search');
      if (profile) searchJobs();
    });
    
    // Search Jobs
    document.getElementById('search-btn').addEventListener('click', searchJobs);
    document.getElementById('search-query').addEventListener('keypress', e => { if (e.key === 'Enter') searchJobs(); });
    
    async function searchJobs() {
      if (!sessionId) { showToast('Please upload resume first', 'error'); return; }
      
      const searchBtn = document.getElementById('search-btn');
      setLoading(searchBtn, 'search', true, 'Searching...');
      
      try {
        const res = await fetch('/api/search-jobs', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            sessionId,
            searchQuery: document.getElementById('search-query').value,
            location: document.getElementById('search-location').value
          })
        });
        
        const data = await res.json();
        if (!data.success) throw new Error(data.error);
        
        jobs = data.data.jobs;
        displayJobs(jobs);
        
        document.getElementById('no-profile-warning').style.display = 'none';
        document.getElementById('job-results').style.display = 'block';
        document.getElementById('jobs-count').textContent = jobs.length;
        document.getElementById('jobs-count').style.display = 'inline';
        
      } catch (err) {
        showToast(err.message || 'Search failed', 'error');
      } finally {
        setLoading(searchBtn, 'search', false, 'Search');
      }
    }
    
    function displayJobs(jobList, filter = 'all') {
      let filtered = jobList;
      if (filter === 'excellent') filtered = jobList.filter(j => j.matchScore >= 80);
      else if (filter === 'good') filtered = jobList.filter(j => j.matchScore >= 60 && j.matchScore < 80);
      
      document.getElementById('results-count').textContent = filtered.length;
      
      document.getElementById('job-list').innerHTML = filtered.length === 0 
        ? '<div class="empty-state"><div class="icon">üîç</div><h3>No jobs match this filter</h3></div>'
        : filtered.map(job => {
          const scoreClass = job.matchScore >= 80 ? 'high' : job.matchScore >= 60 ? 'medium' : 'low';
          const cardClass = job.matchScore >= 80 ? 'excellent' : job.matchScore >= 60 ? 'good' : job.matchScore >= 40 ? 'moderate' : 'low';
          const recClass = job.recommendation === 'APPLY_NOW' ? 'apply-now' : job.recommendation === 'WORTH_APPLYING' ? 'worth-it' : job.recommendation === 'CUSTOMIZE_FIRST' ? 'customize' : 'skip';
          
          return `
            <div class="job-card ${cardClass}" onclick="openJobDetail('${job.id}')">
              <div class="job-header">
                <div>
                  <div class="job-title">${job.title}</div>
                  <div class="job-company">${job.company}</div>
                  <div class="job-meta">
                    <span>üìç ${job.location}</span>
                    ${job.salary ? `<span>üí∞ ${job.salary}</span>` : ''}
                    <span>üïê ${job.postedDate}</span>
                  </div>
                </div>
                <div class="match-score">
                  <div class="match-percent ${scoreClass}">${job.matchScore}%</div>
                  <div class="match-label">Match</div>
                </div>
              </div>
              <div class="flex gap-2 items-center">
                <span class="recommendation-badge ${recClass}">${(job.recommendation || '').replace(/_/g, ' ')}</span>
                ${job.matchingSkills?.length ? `<span class="text-muted" style="font-size: 0.8rem;">‚úì ${job.matchingSkills.slice(0, 3).join(', ')}</span>` : ''}
              </div>
              <div class="job-quick-take">${job.quickTake || job.description}</div>
              <div class="job-actions" onclick="event.stopPropagation()">
                <button class="btn btn-primary btn-sm" onclick="openJobDetail('${job.id}')">View Details</button>
                <button class="btn btn-secondary btn-sm" onclick="generateCoverLetter('${job.id}')">üìù Cover Letter</button>
                <button class="btn btn-secondary btn-sm" onclick="saveJob('${job.id}')">üíæ Save</button>
              </div>
            </div>
          `;
        }).join('');
    }
    
    // Filter tabs
    document.querySelectorAll('[data-filter]').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('[data-filter]').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        displayJobs(jobs, tab.dataset.filter);
      });
    });
    
    // Job Detail Modal
    async function openJobDetail(jobId) {
      currentJob = jobs.find(j => j.id === jobId);
      if (!currentJob) return;
      
      document.getElementById('modal-job-title').textContent = currentJob.title;
      document.getElementById('modal-job-company').textContent = currentJob.company;
      document.getElementById('job-modal').classList.add('open');
      
      const scoreClass = currentJob.matchScore >= 80 ? 'high' : currentJob.matchScore >= 60 ? 'medium' : 'low';
      
      document.getElementById('modal-body').innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
          <div>
            <div class="match-percent ${scoreClass}" style="font-size: 2.5rem;">${currentJob.matchScore}%</div>
            <div class="text-muted">Match Score</div>
          </div>
          <div>
            <span class="recommendation-badge ${currentJob.recommendation === 'APPLY_NOW' ? 'apply-now' : currentJob.recommendation === 'WORTH_APPLYING' ? 'worth-it' : 'customize'}" style="font-size: 0.9rem; padding: 8px 16px;">
              ${(currentJob.recommendation || '').replace(/_/g, ' ')}
            </span>
          </div>
        </div>
        
        <div class="analysis-section">
          <h4>üìù Job Description</h4>
          <p style="color: #94a3b8; line-height: 1.7;">${currentJob.description}</p>
        </div>
        
        <div class="analysis-section">
          <h4>‚úÖ Requirements</h4>
          ${(currentJob.requirements || []).map(r => `<div class="analysis-item">${r}</div>`).join('')}
        </div>
        
        ${currentJob.matchingSkills?.length ? `
        <div class="analysis-section">
          <h4>üí™ Your Matching Skills</h4>
          <div class="skills-list">${currentJob.matchingSkills.map(s => `<span class="skill-tag">${s}</span>`).join('')}</div>
        </div>
        ` : ''}
        
        ${currentJob.missingSkills?.length ? `
        <div class="analysis-section">
          <h4>‚ö†Ô∏è Skills to Highlight/Address</h4>
          <div class="skills-list">${currentJob.missingSkills.map(s => `<span class="skill-tag" style="background: rgba(239, 68, 68, 0.15); color: #ef4444;">${s}</span>`).join('')}</div>
        </div>
        ` : ''}
        
        <div class="analysis-section">
          <h4>üí° Quick Take</h4>
          <div class="analysis-item">${currentJob.quickTake}</div>
        </div>
        
        <div class="flex gap-2 mt-4">
          <button class="btn btn-primary" onclick="generateCoverLetter('${currentJob.id}')">üìù Generate Cover Letter</button>
          <button class="btn btn-secondary" onclick="saveJob('${currentJob.id}'); closeModal();">üíæ Save Job</button>
          <a href="${currentJob.url || '#'}" target="_blank" class="btn btn-secondary">üîó View Original</a>
        </div>
      `;
    }
    
    function closeModal() {
      document.getElementById('job-modal').classList.remove('open');
    }
    
    // Cover Letter
    async function generateCoverLetter(jobId) {
      const job = jobs.find(j => j.id === jobId) || savedJobs.find(j => j.id === jobId);
      if (!job) return;
      
      currentJob = job;
      document.getElementById('cl-job-info').textContent = `For: ${job.title} at ${job.company}`;
      document.getElementById('cover-letter-text').innerHTML = '<div class="loading"></div> Generating your personalized cover letter...';
      document.getElementById('cover-letter-modal').classList.add('open');
      
      try {
        const res = await fetch('/api/generate-cover-letter', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, jobId, companyName: job.company, jobTitle: job.title })
        });
        
        const data = await res.json();
        if (!data.success) throw new Error(data.error);
        
        document.getElementById('cover-letter-text').textContent = data.data.coverLetter;
        
      } catch (err) {
        document.getElementById('cover-letter-text').textContent = 'Failed to generate cover letter. Please try again.';
        showToast(err.message, 'error');
      }
    }
    
    function closeCoverLetterModal() {
      document.getElementById('cover-letter-modal').classList.remove('open');
    }
    
    function copyCoverLetter() {
      const text = document.getElementById('cover-letter-text').textContent;
      navigator.clipboard.writeText(text);
      showToast('Copied to clipboard!', 'success');
    }
    
    function regenerateCoverLetter() {
      if (currentJob) generateCoverLetter(currentJob.id);
    }
    
    // Save Job
    async function saveJob(jobId) {
      const job = jobs.find(j => j.id === jobId);
      if (!job) return;
      
      try {
        const res = await fetch('/api/save-job', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, job, status: 'SAVED' })
        });
        
        const data = await res.json();
        if (!data.success) throw new Error(data.error);
        
        savedJobs = data.data.savedJobs;
        updateTrackerUI();
        showToast('Job saved!', 'success');
        
      } catch (err) {
        showToast(err.message, 'error');
      }
    }
    
    // Update Status
    async function updateJobStatus(jobId, status) {
      try {
        const res = await fetch('/api/update-job-status', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId, jobId, status })
        });
        
        const data = await res.json();
        if (!data.success) throw new Error(data.error);
        
        const job = savedJobs.find(j => j.id === jobId);
        if (job) job.status = status;
        updateTrackerUI();
        showToast(`Status updated to ${status}`, 'success');
        
      } catch (err) {
        showToast(err.message, 'error');
      }
    }
    
    function updateTrackerUI() {
      const counts = { SAVED: 0, APPLIED: 0, INTERVIEW: 0, REJECTED: 0 };
      savedJobs.forEach(j => { if (counts[j.status] !== undefined) counts[j.status]++; });
      
      document.getElementById('stat-saved').textContent = counts.SAVED;
      document.getElementById('stat-applied').textContent = counts.APPLIED;
      document.getElementById('stat-interview').textContent = counts.INTERVIEW;
      document.getElementById('stat-rejected').textContent = counts.REJECTED;
      document.getElementById('saved-count').textContent = savedJobs.length;
      document.getElementById('saved-count').style.display = savedJobs.length ? 'inline' : 'none';
      
      if (savedJobs.length === 0) {
        document.getElementById('no-saved-jobs').style.display = 'block';
        return;
      }
      
      document.getElementById('no-saved-jobs').style.display = 'none';
      
      document.getElementById('saved-jobs-list').innerHTML = savedJobs.map(job => {
        const statusClass = job.status.toLowerCase();
        return `
          <div class="job-card">
            <div class="job-header">
              <div>
                <div class="job-title">${job.title}</div>
                <div class="job-company">${job.company}</div>
                <div class="job-meta">
                  <span>üìç ${job.location}</span>
                  <span class="status-badge ${statusClass}">${job.status}</span>
                </div>
              </div>
              <div class="match-score">
                <div class="match-percent ${job.matchScore >= 70 ? 'high' : 'medium'}">${job.matchScore}%</div>
                <div class="match-label">Match</div>
              </div>
            </div>
            <div class="job-actions">
              <select onchange="updateJobStatus('${job.id}', this.value)" style="padding: 8px 12px; background: #1e1e2e; border: 1px solid #2e2e3e; border-radius: 8px; color: #e2e8f0;">
                <option value="SAVED" ${job.status === 'SAVED' ? 'selected' : ''}>Saved</option>
                <option value="APPLIED" ${job.status === 'APPLIED' ? 'selected' : ''}>Applied</option>
                <option value="INTERVIEW" ${job.status === 'INTERVIEW' ? 'selected' : ''}>Interview</option>
                <option value="OFFER" ${job.status === 'OFFER' ? 'selected' : ''}>Offer</option>
                <option value="REJECTED" ${job.status === 'REJECTED' ? 'selected' : ''}>Rejected</option>
              </select>
              <button class="btn btn-secondary btn-sm" onclick="generateCoverLetter('${job.id}')">üìù Cover Letter</button>
              <a href="${job.url || '#'}" target="_blank" class="btn btn-secondary btn-sm">üîó Apply</a>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // Utilities
    function setLoading(btn, prefix, loading, text) {
      document.getElementById(`${prefix}-btn-text`).textContent = text;
      document.getElementById(`${prefix}-loading`).style.display = loading ? 'inline-block' : 'none';
      btn.disabled = loading;
    }
    
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = `toast ${type} show`;
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    // Close modals on escape
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        closeModal();
        closeCoverLetterModal();
      }
    });
    
    // Load saved jobs on init
    async function loadSavedJobs() {
      if (!sessionId) return;
      try {
        const res = await fetch(`/api/saved-jobs?sessionId=${sessionId}`);
        const data = await res.json();
        if (data.success) {
          savedJobs = data.data.savedJobs || [];
          updateTrackerUI();
        }
      } catch (e) { console.error(e); }
    }
    
    loadSavedJobs();
  </script>
</body>
</html>
